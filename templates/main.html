<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>–ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>

    <style>
        :root {
            --primary: #2e7dff;
            --primary-dark: #1e5ed4;
            --danger: #ff5252;
            --bg: #f9fafb;
        }

        * {
            box-sizing: border-box;
        }

        html,
        body {
            height: 100%;
        }

        body {
            margin: 0;
            padding: 0 1rem;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
            background: var(--bg);
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        header {
            margin-top: 1.5rem;
            text-align: center;
        }

        header h1 {
            margin: 0 0 0.25rem;
            font-size: 1.7rem;
        }

        #instructions {
            margin: 0 0 1rem;
            font-size: 0.95rem;
            color: #555;
            text-align: left;
            max-width: 480px;
        }

        #instructions strong {
            display: inline-block;
            margin-top: 0.5rem;
            font-size: 1rem;
            color: #000;
        }

        #instructions b {
            color: #1e5ed4;
        }

        #user-info {
            font-weight: 600;
            margin-bottom: 1rem;
            text-align: center;
        }

        .menu-group {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 1.5rem;
            gap: 0.75rem;
        }

        .menu-title {
            margin: 0 0 0.5rem;
            font-size: 1.1rem;
            font-weight: 600;
            color: #333;
        }

        .button-row {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            width: 90vw;
            max-width: 420px;
            justify-content: center;
        }

        .btn-primary {
            width: 100%;
            padding: 1.2rem 2rem;
            font-size: 1.25rem;
            font-weight: 600;
            text-transform: uppercase;
            color: #fff;
            background: var(--primary);
            border: none;
            border-radius: 14px;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.15);
            transition: background 0.2s ease, transform 0.1s ease;
        }

        .btn-primary:active {
            background: var(--primary-dark);
            transform: scale(0.98);
        }

        .info-btn {
            background: none;
            border: none;
            font-size: 1.4rem;
            cursor: pointer;
            line-height: 1;
            padding: 0;
            margin: 0;
            color: #2e7dff;
        }

        #scanner {
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.3s ease;
            flex-direction: column;
            align-items: center;
            width: 100%;
            height: 0;
            overflow: hidden;
        }

        #scanner.active {
            visibility: visible;
            opacity: 1;
            height: auto;
        }

        #video {
            width: 100%;
            max-width: 480px;
            border: 3px solid var(--primary);
            border-radius: 12px;
            background: #000;
        }

        #output {
            margin-top: 1rem;
            font-weight: 600;
            text-align: center;
        }

        #stop-btn {
            margin-top: 1rem;
            padding: 0.9rem 1.6rem;
            font-size: 1.05rem;
            font-weight: 600;
            color: #fff;
            background: var(--danger);
            border: none;
            border-radius: 10px;
            cursor: pointer;
            box-shadow: 0 3px 5px rgba(0, 0, 0, 0.15);
            transition: background 0.2s ease, transform 0.1s ease;
        }

        #stop-btn:active {
            background: #d63c3c;
            transform: scale(0.98);
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.4);
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            padding: 1.5rem;
            border-radius: 10px;
            max-width: 360px;
            text-align: left;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            font-size: 1rem;
            position: relative;
        }

        #modal-close {
            position: absolute;
            right: 1rem;
            top: 0.5rem;
            font-size: 1.4rem;
            cursor: pointer;
            color: #999;
        }
    </style>
</head>

<body>
    <header>
        <h1>–°–∫–∞–Ω–µ—Ä QR‚Äë–∫–æ–¥–æ–≤</h1>
        <p id="instructions">
            –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø —Ä–∞–±–æ—Ç—ã –∏ –æ—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR‚Äë–∫–æ–¥ –∑–∞–∫–∞–∑–∞.<br><br>
            <strong>Kaspi –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å:</strong><br>
            ‚ñ∏ <b>–£–ü–ê–ö–û–í–ö–ê</b> ‚Äî –µ—Å–ª–∏ –≤—ã —É–ø–∞–∫–æ–≤–∞–ª–∏ –∑–∞–∫–∞–∑.<br>
            ‚ñ∏ <b>–ü–û–ì–†–£–ó–ö–ê</b> ‚Äî –µ—Å–ª–∏ –≤—ã –ø–æ–≥—Ä—É–∑–∏–ª–∏ –∑–∞–∫–∞–∑.<br><br>
            <strong>–ü—Ä–æ—á–∏–µ —Ä–∞–±–æ—Ç—ã:</strong><br>
            ‚ñ∏ <b>–†–ê–ë–û–¢–´ –° –¢–û–í–ê–†–û–ú</b> ‚Äî –µ—Å–ª–∏ —É—á–∞—Å—Ç–≤–æ–≤–∞–ª–∏ –≤ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–∏ –º–µ–∂–¥—É —Å–∫–ª–∞–¥–∞–º–∏, —Ä–∞–∑–≥—Ä—É–∑–∫–µ –ø–æ—Å—Ç–∞–≤–∫–∏ –∏ —Ç.–ø.<br><br>
            <strong>–í–∞–∂–Ω–æ:</strong><br>
            –ü–æ–≤—Ç–æ—Ä–Ω–æ–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–¥–Ω–æ–≥–æ QR‚Äë–∫–æ–¥–∞ –Ω–µ —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –±–æ–Ω—É—Å.<br>
            –ë–æ–Ω—É—Å –¥–µ–ª–∏—Ç—Å—è –º–µ–∂–¥—É —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º–∏, –æ—Ç—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–≤—à–∏–º–∏ –æ–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ QR.
        </p>
    </header>

    <p id="user-info">–û–ø—Ä–µ–¥–µ–ª—è—é chat_id‚Ä¶</p>

    <div id="menu">
        <div class="menu-group">
            <h2 class="menu-title">üì¶ Kaspi –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å</h2>
            <div class="button-row">
                <button id="load-btn" class="btn-primary">üöö –ü–û–ì–†–£–ó–ö–ê</button>
                <button class="info-btn" data-type="load">‚ÑπÔ∏è</button>
            </div>
            <div class="button-row">
                <button id="pack-btn" class="btn-primary">üì¶ –£–ü–ê–ö–û–í–ö–ê</button>
                <button class="info-btn" data-type="pack">‚ÑπÔ∏è</button>
            </div>
        </div>

        <div class="menu-group">
            <h2 class="menu-title">üîÑ –ü—Ä–æ—á–∏–µ —Ä–∞–±–æ—Ç—ã —Å —Ç–æ–≤–∞—Ä–æ–º</h2>
            <div class="button-row">
                <button id="work-btn" class="btn-primary">üë∑üèª‚Äç‚ôÇÔ∏èüîß –†–ê–ë–û–¢–´ –° –¢–û–í–ê–†–û–ú</button>
                <button class="info-btn" data-type="work">‚ÑπÔ∏è</button>
            </div>
        </div>
    </div>

    <div id="scanner">
        <video id="video" autoplay></video>
        <canvas id="canvas" hidden></canvas>
        <p id="output"></p>
        <button id="stop-btn">–ó–∞–∫—Ä—ã—Ç—å –∫–∞–º–µ—Ä—É</button>
    </div>

    <div id="modal" class="modal">
        <div class="modal-content">
            <span id="modal-close">&times;</span>
            <p id="modal-text"></p>
        </div>
    </div>

    <!-- jsQR ‚Äì —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ QR –∏–∑ Canvas -->
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
    <script>
        /********** Telegram init + chatId **********/
        const tg = window.Telegram?.WebApp; tg?.ready();
        const init = tg?.initDataUnsafe || {};
        const chatId = init.user?.id ?? init.receiver?.id ?? init.chat?.id ?? null;
        document.getElementById('user-info').textContent = chatId ? `–í–∞—à chat_id: ${chatId}` : 'chat_id –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.';

        const qrApiBase = {{ qr_api_base | tojson }};

        /********** DOM —Å—Å—ã–ª–∫–∏ **********/
        const loadBtn = document.getElementById('load-btn');
        const packBtn = document.getElementById('pack-btn');
        const workBtn = document.getElementById('work-btn');
        const stopBtn = document.getElementById('stop-btn');
        const menuDiv = document.getElementById('menu');
        const scannerDiv = document.getElementById('scanner');
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const output = document.getElementById('output');

        /********** –°–æ—Å—Ç–æ—è–Ω–∏–µ **********/
        let streamRef = null;
        let scanning = false;
        let operation = '';

        loadBtn.addEventListener('click', () => startScan('shipment'));
        packBtn.addEventListener('click', () => startScan('packing'));
        workBtn.addEventListener('click', () => startScan('work'));
        stopBtn.addEventListener('click', stopScanning);

        async function startScan(op) {
            operation = op;
            output.textContent = `–†–µ–∂–∏–º: ${operation}. –ù–∞–≤–µ–¥–∏—Ç–µ –∫–∞–º–µ—Ä—É –Ω–∞ QR‚Äë–∫–æ–¥‚Ä¶`;

            const isIOS = tg?.platform === 'ios' || /iPhone|iPad|iPod/i.test(navigator.userAgent);
            if (isIOS && typeof tg?.showScanQrPopup === 'function') {
                try {
                    scanning = true;
                    tg.showScanQrPopup();
                    tg.onEvent('qrTextReceived', ({ data }) => handleQr(data));
                    // fallback —á–µ—Ä–µ–∑ 3¬†—Å–µ–∫, –µ—Å–ª–∏ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª showScanQrPopup
                    setTimeout(() => {
                        if (scanning) {
                            openWebCamera();
                        }
                    }, 3000);
                    return;
                } catch (e) {
                    console.warn('showScanQrPopup error', e);
                }
            }

            // fallback: –æ—Ç–∫—Ä—ã–≤–∞–µ–º –∫–∞–º–µ—Ä—É —Å—Ä–∞–∑—É
            openWebCamera();
        }

        async function openWebCamera() {
            try {
                const constraints = { video: { facingMode: 'environment' } };
                streamRef = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = streamRef;
                video.onloadedmetadata = () => {
                    video.play();
                    scannerDiv.classList.add('active');
                    menuDiv.style.display = 'none';
                    scanning = true;
                    requestAnimationFrame(scanFrame);
                };
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ:', e);
                output.textContent = '–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ';
            }
        }

        function stopScanning() {
            scanning = false;
            if (streamRef) {
                streamRef.getTracks().forEach(t => t.stop());
                streamRef = null;
            }
            video.pause();
            video.srcObject = null;
            video.load();

            scannerDiv.classList.remove('active');
            menuDiv.style.display = 'flex';

            output.textContent = '';
            operation = '';
            setTimeout(() => {
                location.reload();
            }, 100);
        }

        function scanFrame() {
            if (!scanning) return;
            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                canvas.height = video.videoHeight;
                canvas.width = video.videoWidth;
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                const img = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const code = jsQR(img.data, img.width, img.height);
                if (code) { handleQr(code.data); return; }
            }
            requestAnimationFrame(scanFrame);
        }

        function handleQr(qrDataRaw) {
            if (!operation) return;
            scanning = false;
            console.log(`[${operation}] QR (raw):`, qrDataRaw, 'chatId:', chatId);
            output.textContent = '–û—Ç–ø—Ä–∞–≤–ª—è—é –¥–∞–Ω–Ω—ã–µ‚Ä¶';

            let qrData = null;
            try {
                qrData = JSON.parse(qrDataRaw); // ‚úÖ –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —Å—Ç—Ä–æ–∫—É –≤ –æ–±—ä–µ–∫—Ç
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ QR:', e);
                output.textContent = '–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç QR‚Äë–∫–æ–¥–∞';
                scanning = true;
                requestAnimationFrame(scanFrame);
                return;
            }

            const payload = {
                operation: operation,
                userId: chatId ?? '',
                qrData: qrData,
            };

            if (operation === "work") {
                console.log("WORK payload:", payload);
                fetch("http://0.0.0.0:8008/cb/api/cargo_qr/", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify(payload),
                })
                    .then(res => {
                        if (res.ok) {
                            output.textContent = '–£—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!';
                            stopScanning();
                        } else {
                            output.textContent = `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ (${res.status}). –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ.`;
                            scanning = true;
                            requestAnimationFrame(scanFrame);
                        }
                    })
                    .catch(err => {
                        console.error('API error', err);
                        output.textContent = '–°–µ—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞. –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ.';
                        scanning = true;
                        requestAnimationFrame(scanFrame);
                    });

                return;
            }

            // –¥–ª—è –¥—Ä—É–≥–∏—Ö operation –º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å params –∫–∞–∫ —Ä–∞–Ω—å—à–µ
            const params = new URLSearchParams({
                operation,
                userId: chatId ?? '',
                qrData: qrDataRaw,
            });

            fetch(`${qrApiBase}?${params.toString()}`)
                .then(res => {
                    if (res.ok) {
                        output.textContent = '–£—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!';
                        stopScanning();
                    } else {
                        output.textContent = `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ (${res.status}). –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ.`;
                        scanning = true;
                        requestAnimationFrame(scanFrame);
                    }
                })
                .catch(err => {
                    console.error('API error', err);
                    output.textContent = '–°–µ—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞. –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ.';
                    scanning = true;
                    requestAnimationFrame(scanFrame);
                });
        }
    </script>
    <script>
        const modal = document.getElementById('modal');
        const modalText = document.getElementById('modal-text');
        const modalClose = document.getElementById('modal-close');

        document.querySelectorAll('.info-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const type = btn.dataset.type;
                let text = '';

                switch (type) {
                    case 'load':
                        text = '–í—ã–±–µ—Ä–∏—Ç–µ "–ü–û–ì–†–£–ó–ö–ê", –µ—Å–ª–∏ –≤—ã –∑–∞–≥—Ä—É–∂–∞–µ—Ç–µ —É–ø–∞–∫–æ–≤–∞–Ω–Ω—ã–π —Ç–æ–≤–∞—Ä –Ω–∞ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–æ–∫—É–ø–∞—Ç–µ–ª—é (Kaspi).';
                        break;
                    case 'pack':
                        text = '–í—ã–±–µ—Ä–∏—Ç–µ "–£–ü–ê–ö–û–í–ö–ê", –µ—Å–ª–∏ –≤—ã –ø–æ–¥–≥–æ—Ç–æ–≤–∏–ª–∏ —Ç–æ–≤–∞—Ä –∫ –æ—Ç–ø—Ä–∞–≤–∫–µ (—É–ø–∞–∫–æ–≤–∞–ª–∏ –∑–∞–∫–∞–∑ Kaspi).';
                        break;
                    case 'work':
                        text = '–í—ã–±–µ—Ä–∏—Ç–µ "–†–ê–ë–û–¢–´ –° –¢–û–í–ê–†–û–ú", –µ—Å–ª–∏ –≤—ã –≤—ã–ø–æ–ª–Ω—è–µ—Ç–µ –∑–∞–¥–∞—á–∏: —Ä–∞–∑–≥—Ä—É–∑–∫–∞, –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –º–µ–∂–¥—É —Å–∫–ª–∞–¥–∞–º–∏, –ø—Ä–∏—ë–º —Ç–æ–≤–∞—Ä–∞ –æ—Ç –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞ –∏ –¥—Ä—É–≥–∏–µ —Å–∫–ª–∞–¥—Å–∫–∏–µ –∏–ª–∏ –ª–æ–≥–∏—Å—Ç–∏—á–µ—Å–∫–∏–µ –¥–µ–π—Å—Ç–≤–∏—è.';
                        break;
                }

                modalText.textContent = text;
                modal.style.display = 'flex';
            });
        });

        modalClose.addEventListener('click', () => {
            modal.style.display = 'none';
        });
        modal.addEventListener('click', (e) => {
            if (e.target === modal) modal.style.display = 'none';
        });

    </script>
</body>

</html>