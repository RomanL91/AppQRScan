<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Главная страница</title>

    <!-- Telegram Web‑App SDK (безопасно подключить даже внутри Telegram) -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <style>
        :root {
            --primary: #2e7dff;
            --primary-dark: #1e5ed4;
            --danger: #ff5252;
            --bg: #f9fafb;
        }

        * {
            box-sizing: border-box;
        }

        html,
        body {
            height: 100%;
        }

        body {
            margin: 0;
            padding: 0 1rem;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
            background: var(--bg);
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        header {
            margin-top: 1.5rem;
            text-align: center;
        }

        header h1 {
            margin: 0 0 0.25rem;
            font-size: 1.7rem;
        }

        #instructions {
            margin: 0 0 1rem;
            font-size: 0.95rem;
            color: #555;
        }

        #user-info {
            font-weight: 600;
            margin-bottom: 1rem;
            text-align: center;
        }

        /* -------- кнопки меню -------- */
        #menu {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 2rem;
        }

        #menu button {
            width: 90vw;
            max-width: 420px;
            padding: 1.2rem 2rem;
            font-size: 1.25rem;
            font-weight: 600;
            text-transform: uppercase;
            color: #fff;
            background: var(--primary);
            border: none;
            border-radius: 14px;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.15);
            transition: background 0.2s ease, transform 0.1s ease;
        }

        #menu button:active {
            background: var(--primary-dark);
            transform: scale(0.98);
        }

        /* -------- сканер -------- */
        #scanner {
            display: none;
            flex-direction: column;
            align-items: center;
            width: 100%;
        }

        #video {
            width: 100%;
            max-width: 480px;
            border: 3px solid var(--primary);
            border-radius: 12px;
            background: #000;
        }

        #output {
            margin-top: 1rem;
            font-weight: 600;
            text-align: center;
        }

        #stop-btn {
            margin-top: 1rem;
            padding: 0.9rem 1.6rem;
            font-size: 1.05rem;
            font-weight: 600;
            color: #fff;
            background: var(--danger);
            border: none;
            border-radius: 10px;
            cursor: pointer;
            box-shadow: 0 3px 5px rgba(0, 0, 0, 0.15);
            transition: background 0.2s ease, transform 0.1s ease;
        }

        #stop-btn:active {
            background: #d63c3c;
            transform: scale(0.98);
        }
    </style>
</head>

<body>
    <header>
        <h1>Сканер QR‑кодов</h1>
        <p id="instructions">
            Выберите режим работы и отсканируйте QR‑код.
            <br>
            Если Вы занимались, например, упаковкой товара - выберите режим "УПАКОВКА", отсканируйте QR, чтобы эта
            работа была учтена за Вами.
            <br>
            Если Вы занимались и погрузкой - выберите режим "ПОГРУЗКА" и отсканируйте QR.
            <br>
            <br>
            Предупреждения!
            <br>
            Не имеет смысла сканировать несколько раз с одним и тем же режимом.
            <br>
            Если другой сотрудник так же отсканирует QR-код заказа - Вы разделите бонусные баллы между собой.


        </p>
    </header>

    <p id="user-info">Определяю chat_id…</p>

    <div id="menu">
        <button id="load-btn">ПОГРУЗКА</button>
        <button id="pack-btn">УПАКОВКА</button>
    </div>

    <div id="scanner">
        <video id="video" autoplay></video>
        <canvas id="canvas" hidden></canvas>
        <p id="output"></p>
        <button id="stop-btn">Закрыть камеру</button>
    </div>

    <!-- jsQR – распознавание QR из Canvas -->
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
    <script>
        /********** Telegram init + chatId **********/
        const tg = window.Telegram?.WebApp; tg?.ready();
        const init = tg?.initDataUnsafe || {};
        const chatId = init.user?.id ?? init.receiver?.id ?? init.chat?.id ?? null;
        document.getElementById('user-info').textContent = chatId ? `Ваш chat_id: ${chatId}` : 'chat_id недоступен.';

        const qrApiBase = {{ qr_api_base | tojson }};

        /********** DOM ссылки **********/
        const loadBtn = document.getElementById('load-btn');
        const packBtn = document.getElementById('pack-btn');
        const stopBtn = document.getElementById('stop-btn');
        const menuDiv = document.getElementById('menu');
        const scannerDiv = document.getElementById('scanner');
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const output = document.getElementById('output');

        /********** Состояние **********/
        let streamRef = null;
        let scanning = false;
        let operation = '';

        loadBtn.addEventListener('click', () => startScan('shipment'));
        packBtn.addEventListener('click', () => startScan('packing'));
        stopBtn.addEventListener('click', stopScanning);

        async function startScan(op) {
            operation = op;
            menuDiv.style.display = 'none';
            scannerDiv.style.display = 'flex';
            output.textContent = `Режим: ${operation}. Наведите камеру на QR‑код…`;

            // iOS: сначала попробуем нативный сканер Telegram
            const isIOS = tg?.platform === 'ios' || /iPhone|iPad|iPod/i.test(navigator.userAgent);
            if (isIOS && typeof tg?.showScanQrPopup === 'function') {
                try {
                    scanning = true; // чтобы таймаут понимал, что скан запущен
                    tg.showScanQrPopup();
                    tg.onEvent('qrTextReceived', ({ data }) => handleQr(data));
                    // fallback через 3 сек — если пользователь закрыл сканер
                    setTimeout(() => { if (scanning) openWebCamera(); }, 3000);
                    return;
                } catch (e) { console.warn('showScanQrPopup error', e); }
            }
            // Десктоп / Android / fallback
            openWebCamera();
        }

        async function openWebCamera() {
            try {
                const constraints = { video: { facingMode: 'environment' } };
                streamRef = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = streamRef;
                video.onloadedmetadata = () => {
                    video.play();
                    scanning = true;
                    requestAnimationFrame(scanFrame);
                };
            } catch (e) {
                console.error('Ошибка доступа к камере:', e);
                output.textContent = 'Ошибка доступа к камере';
            }
        }

        function stopScanning() {
            scanning = false;
            if (streamRef) {
                streamRef.getTracks().forEach(t => t.stop());
                streamRef = null;
            }
            video.pause();
            video.srcObject = null;
            video.load();

            scannerDiv.style.display = 'none';
            menuDiv.style.display = 'flex';

            output.textContent = '';
            operation = '';
        }

        function scanFrame() {
            if (!scanning) return;
            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                canvas.height = video.videoHeight;
                canvas.width = video.videoWidth;
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                const img = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const code = jsQR(img.data, img.width, img.height);
                if (code) { handleQr(code.data); return; }
            }
            requestAnimationFrame(scanFrame);
        }

        function handleQr(qrData) {
            if (!operation) return;          // защита от лишних вызовов
            scanning = false;                // перестаём анализировать кадры, но камеру держим
            console.log(`[${operation}] QR:`, qrData, 'chatId:', chatId);
            output.textContent = 'Отправляю данные…';

            const params = new URLSearchParams({
                operation,
                userId: chatId ?? '',
                qrData
            });

            fetch(`${qrApiBase}?${params.toString()}`)
                .then(res => {
                    if (res.ok) {
                        output.textContent = 'Успешно отправлено!';
                        stopScanning();      // закрываем камеру и возвращаем меню
                    } else {
                        output.textContent = `Ошибка сервера (${res.status}). Повторите.`;
                        scanning = true;     // разрешаем повторный скан
                        requestAnimationFrame(scanFrame);
                    }
                })
                .catch(err => {
                    console.error('API error', err);
                    output.textContent = 'Сеть недоступна. Повторите.';
                    scanning = true;
                    requestAnimationFrame(scanFrame);
                });
        }
    </script>
</body>

</html>